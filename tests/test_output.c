#include "test_framework.h"
#include <stdio.h>
#include <string.h>
#include <stdint.h>
#include "../src/types/output.h"
#include "../src/utils.h"

// Test vector 1: P2PKH with EC key
static void test_output_pkh_ec() {
    TEST_CASE("Test Vector 1: P2PKH with EC key");

    const uint8_t cbor_data[] = {
        0xd9, 0x01, 0x93, 0xd9, 0x01, 0x32, 0xa1, 0x03, 0x58, 0x21, 0x02, 0xc6,
        0x04, 0x7f, 0x94, 0x41, 0xed, 0x7d, 0x6d, 0x30, 0x45, 0x40, 0x6e, 0x95,
        0xc0, 0x7c, 0xd8, 0x5c, 0x77, 0x8e, 0x4b, 0x8c, 0xef, 0x3c, 0xa7, 0xab,
        0xac, 0x09, 0xb9, 0x5c, 0x70, 0x9e, 0xe5
    };
    const char *expected_descriptor = "pkh(02c6047f9441ed7d6d3045406e95c07cd85c778e4b8cef3ca7abac09b95c709ee5)";
    const char *expected_checksum = "#8fhd9pwu";

    output_data_t *output = output_from_cbor(cbor_data, sizeof(cbor_data));
    ASSERT_NOT_NULL(output, "Failed to parse CBOR");

    char *descriptor = output_descriptor(output, false);
    ASSERT_NOT_NULL(descriptor, "Failed to generate descriptor");
    ASSERT_STRING_EQUAL(descriptor, expected_descriptor, "Descriptor mismatch");

    char *descriptor_with_checksum = output_descriptor(output, true);
    ASSERT_NOT_NULL(descriptor_with_checksum, "Failed to generate descriptor with checksum");

    char expected_full[256];
    sprintf(expected_full, "%s%s", expected_descriptor, expected_checksum);
    ASSERT_STRING_EQUAL(descriptor_with_checksum, expected_full, "Descriptor with checksum mismatch");

    free(descriptor);
    free(descriptor_with_checksum);
    output_free(output);
}

// Test vector 2: P2SH-P2WPKH with EC key
static void test_output_sh_wpkh_ec() {
    TEST_CASE("Test Vector 2: P2SH-P2WPKH with EC key");

    const uint8_t cbor_data[] = {
        0xd9, 0x01, 0x90, 0xd9, 0x01, 0x94, 0xd9, 0x01, 0x32, 0xa1, 0x03, 0x58,
        0x21, 0x03, 0xff, 0xf9, 0x7b, 0xd5, 0x75, 0x5e, 0xee, 0xa4, 0x20, 0x45,
        0x3a, 0x14, 0x35, 0x52, 0x35, 0xd3, 0x82, 0xf6, 0x47, 0x2f, 0x85, 0x68,
        0xa1, 0x8b, 0x2f, 0x05, 0x7a, 0x14, 0x60, 0x29, 0x75, 0x56
    };
    const char *expected_descriptor = "sh(wpkh(03fff97bd5755eeea420453a14355235d382f6472f8568a18b2f057a1460297556))";

    output_data_t *output = output_from_cbor(cbor_data, sizeof(cbor_data));
    ASSERT_NOT_NULL(output, "Failed to parse CBOR");

    char *descriptor = output_descriptor(output, false);
    ASSERT_NOT_NULL(descriptor, "Failed to generate descriptor");
    ASSERT_STRING_EQUAL(descriptor, expected_descriptor, "Descriptor mismatch");

    free(descriptor);
    output_free(output);
}

// Test vector 3: P2SH 2-of-2 multisig with EC keys
static void test_output_sh_multi_ec() {
    TEST_CASE("Test Vector 3: P2SH 2-of-2 multisig");

    const uint8_t cbor_data[] = {
        0xd9, 0x01, 0x90, 0xd9, 0x01, 0x96, 0xa2, 0x01, 0x02, 0x02, 0x82, 0xd9,
        0x01, 0x32, 0xa1, 0x03, 0x58, 0x21, 0x02, 0x2f, 0x01, 0xe5, 0xe1, 0x5c,
        0xca, 0x35, 0x1d, 0xaf, 0xf3, 0x84, 0x3f, 0xb7, 0x0f, 0x3c, 0x2f, 0x0a,
        0x1b, 0xdd, 0x05, 0xe5, 0xaf, 0x88, 0x8a, 0x67, 0x78, 0x4e, 0xf3, 0xe1,
        0x0a, 0x2a, 0x01, 0xd9, 0x01, 0x32, 0xa1, 0x03, 0x58, 0x21, 0x03, 0xac,
        0xd4, 0x84, 0xe2, 0xf0, 0xc7, 0xf6, 0x53, 0x09, 0xad, 0x17, 0x8a, 0x9f,
        0x55, 0x9a, 0xbd, 0xe0, 0x97, 0x96, 0x97, 0x4c, 0x57, 0xe7, 0x14, 0xc3,
        0x5f, 0x11, 0x0d, 0xfc, 0x27, 0xcc, 0xbe
    };
    const char *expected_descriptor = "sh(multi(2,022f01e5e15cca351daff3843fb70f3c2f0a1bdd05e5af888a67784ef3e10a2a01,03acd484e2f0c7f65309ad178a9f559abde09796974c57e714c35f110dfc27ccbe))";

    output_data_t *output = output_from_cbor(cbor_data, sizeof(cbor_data));
    ASSERT_NOT_NULL(output, "Failed to parse CBOR");

    char *descriptor = output_descriptor(output, false);
    ASSERT_NOT_NULL(descriptor, "Failed to generate descriptor");
    ASSERT_STRING_EQUAL(descriptor, expected_descriptor, "Descriptor mismatch");

    free(descriptor);
    output_free(output);
}

// Test vector 4: P2PKH with HD key with origin and children paths
static void test_output_pkh_hd() {
    TEST_CASE("Test Vector 4: P2PKH with HD key");

    const uint8_t cbor_data[] = {
        0xd9, 0x01, 0x93, 0xd9, 0x01, 0x2f, 0xa5, 0x03, 0x58, 0x21, 0x02, 0xd2,
        0xb3, 0x69, 0x00, 0x39, 0x6c, 0x92, 0x82, 0xfa, 0x14, 0x62, 0x85, 0x66,
        0x58, 0x2f, 0x20, 0x6a, 0x5d, 0xd0, 0xbc, 0xc8, 0xd5, 0xe8, 0x92, 0x61,
        0x18, 0x06, 0xca, 0xfb, 0x03, 0x01, 0xf0, 0x04, 0x58, 0x20, 0x63, 0x78,
        0x07, 0x03, 0x0d, 0x55, 0xd0, 0x1f, 0x9a, 0x0c, 0xb3, 0xa7, 0x83, 0x95,
        0x15, 0xd7, 0x96, 0xbd, 0x07, 0x70, 0x63, 0x86, 0xa6, 0xed, 0xdf, 0x06,
        0xcc, 0x29, 0xa6, 0x5a, 0x0e, 0x29, 0x06, 0xd9, 0x01, 0x30, 0xa2, 0x01,
        0x86, 0x18, 0x2c, 0xf5, 0x00, 0xf5, 0x00, 0xf5, 0x02, 0x1a, 0xd3, 0x4d,
        0xb3, 0x3f, 0x07, 0xd9, 0x01, 0x30, 0xa1, 0x01, 0x84, 0x01, 0xf4, 0x80,
        0xf4, 0x08, 0x1a, 0x78, 0x41, 0x2e, 0x3a
    };
    const char *expected_descriptor = "pkh([d34db33f/44'/0'/0']xpub6CY2xt3mvQejPFUw26CychtL4GMq1yp41aMW2U27mvThqefpZYwXpGscV26JuVj13Fpg4kgSENheUSbTqm5f8z25zrhXpPVss5zWeMGnAKR/1/*)";

    output_data_t *output = output_from_cbor(cbor_data, sizeof(cbor_data));
    ASSERT_NOT_NULL(output, "Failed to parse CBOR");

    char *descriptor = output_descriptor(output, false);
    ASSERT_NOT_NULL(descriptor, "Failed to generate descriptor");
    ASSERT_STRING_EQUAL(descriptor, expected_descriptor, "Descriptor mismatch");

    free(descriptor);
    output_free(output);
}

int main() {
    TEST_SUITE_START("Output Descriptor Tests");

    test_output_pkh_ec();
    test_output_sh_wpkh_ec();
    test_output_sh_multi_ec();
    test_output_pkh_hd();

    TEST_SUITE_END();

    return tests_failed > 0 ? 1 : 0;
}
